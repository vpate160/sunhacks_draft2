<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphRAG Knowledge Exploration Interface</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Core Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Query Section Styles */
        .query-section {
            margin-bottom: 2rem;
        }

        .query-section h2 {
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 0.8rem 1.5rem;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn:hover, .mode-btn.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .query-form {
            margin: 2rem 0;
        }

        .query-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        .query-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .query-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .query-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .query-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Examples Styles */
        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .example {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .example:hover {
            background: #e3f2fd;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        /* Results Styles */
        .result {
            margin-top: 2rem;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .graph-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-box {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        /* Analysis Section Styles */
        .analysis-section {
            margin-bottom: 1rem;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
        }

        .section-content.expanded {
            padding: 1rem;
            max-height: none;
        }

        .toggle-arrow {
            transition: transform 0.2s;
            font-size: 1rem;
            color: #6c757d;
        }

        .toggle-arrow.expanded {
            transform: rotate(90deg);
        }

        /* Graph Styles */
        #detailedGraphSvg {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Loading Styles */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Styles */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 1rem 0;
        }

        /* Success Styles */
        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin: 1rem 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .mode-toggle {
                flex-direction: column;
                align-items: center;
            }
            
            .examples {
                grid-template-columns: 1fr;
            }
            
            .graph-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="query-section">
            <h2>üîç GraphRAG Knowledge Exploration</h2>
            <p style="margin-bottom: 2rem; color: #666; text-align: center;">
                Explore connections in our knowledge graph with AI-powered reasoning
            </p>

            <!-- GraphRAG Mode Selector -->
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('research')" id="research-mode">
                    üìä Research Analysis
                </button>
                <button class="mode-btn" onclick="setMode('concept')" id="concept-mode">
                    üß† Concept Explorer
                </button>
                <button class="mode-btn" onclick="setMode('papers')" id="papers-mode">
                    üìö Paper Discovery
                </button>
            </div>

            <div style="margin-bottom: 2rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                <button class="query-btn" onclick="showHelp()" style="background: #6c757d; padding: 0.8rem 1.5rem; border-radius: 25px; border: 2px solid white; color: white; font-size: 0.9rem; width: auto;">
                    ‚ùì How It Works
                </button>
            </div>

            <form class="query-form" onsubmit="submitQuery(event)">
                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                    <select id="queryType" class="query-input" style="width: auto;">
                        <option value="analyze">üî¨ Analyze Concept</option>
                        <option value="explore">üó∫Ô∏è Explore Connections</option>
                        <option value="compare">‚öñÔ∏è Compare Research</option>
                        <option value="trends">üìà Find Trends</option>
                        <option value="gaps">üîç Identify Gaps</option>
                    </select>
                </div>
                <textarea id="queryInput" class="query-input" placeholder="Enter your research question or concept to explore..." rows="3" required></textarea>
                <button type="submit" class="query-btn" id="queryBtn">üß¨ Analyze with GraphRAG</button>
            </form>

            <div class="examples">
                <div class="example" onclick="setGraphQuery('microgravity cellular pathways')">
                    <strong>üî¨ Pathway Analysis</strong><br>
                    Explore cellular pathway connections in microgravity
                </div>
                <div class="example" onclick="setGraphQuery('radiation DNA repair mechanisms')">
                    <strong>üß¨ Mechanism Discovery</strong><br>
                    Find DNA repair mechanism relationships
                </div>
                <div class="example" onclick="setGraphQuery('spaceflight gene expression networks')">
                    <strong>üï∏Ô∏è Network Analysis</strong><br>
                    Map gene expression networks in space
                </div>
                <div class="example" onclick="setGraphQuery('muscle atrophy protein interactions')">
                    <strong>‚öõÔ∏è Protein Networks</strong><br>
                    Discover protein interaction patterns
                </div>
            </div>

            <div id="result" class="result" style="display: none;">
                <h3>Analysis Result:</h3>
                <div id="resultContent">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <div id="analysisGraphPanel" style="display: none;">
                <div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef;">
                    <h3 style="margin-bottom: 1rem; text-align: center; color: #495057;">üï∏Ô∏è Interactive Knowledge Graph</h3>
                    <div style="padding: 1rem;">
                        <div style="margin-bottom: 1rem; text-align: center;">
                            <h4 style="color: #667eea; margin-bottom: 0.5rem;" id="graphTitle">üß¨ Research Network</h4>
                            <div style="display: flex; justify-content: center; gap: 2rem; margin: 1rem 0; font-size: 0.9rem; flex-wrap: wrap;" id="graphStats">
                                <!-- Graph stats will be populated here -->
                            </div>
                        </div>
                        <svg id="detailedGraphSvg"></svg>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: center; gap: 2rem; font-size: 0.8rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <span style="color: #5a67d8;">üîµ Core Concepts</span>
                                <span style="color: #38b2ac;">üü¢ Primary Papers</span>
                                <span style="color: #ed8936;">üü† Supporting Studies</span>
                                <span style="color: #9f7aea;">üü£ Applications</span>
                            </div>
                            <div style="text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                                Interactive Network: Drag nodes ‚Ä¢ Hover for details ‚Ä¢ Real-time relationships
                            </div>
                            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button onclick="exportCurrentGraph()" class="query-btn" style="background: #28a745; font-size: 0.9rem; width: auto;">
                                    üíæ Export Network Data
                                </button>
                                <button onclick="showNetworkStats()" class="query-btn" style="background: #17a2b8; font-size: 0.9rem; width: auto;">
                                    üìä Show Statistics
                                </button>
                                <button onclick="resetGraphView()" class="query-btn" style="background: #6c757d; font-size: 0.9rem; width: auto;">
                                    ‚Üª Reset View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Configuration
        const API_CONFIG = {
            BASE_URL: 'http://localhost:8000',
            TIMEOUT: 30000,
            RETRY_ATTEMPTS: 3
        };

        // Global State
        let currentMode = 'research';
        let currentGraphData = null;
        let currentSimulation = null;

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            console.log('GraphRAG Interface initialized');
            setMode('research');
        });

        // Mode Management
        function setMode(mode) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');
            
            console.log(`Mode set to: ${mode}`);
        }

        // Query Management
        function setGraphQuery(query) {
            document.getElementById('queryInput').value = query;
            document.getElementById('queryInput').focus();
        }

        async function submitQuery(event) {
            event.preventDefault();
            
            const query = document.getElementById('queryInput').value.trim();
            const queryType = document.getElementById('queryType').value;
            
            if (!query) {
                showError('Please enter a query');
                return;
            }
            
            console.log(`Submitting query: "${query}" with type: ${queryType}`);
            
            // Show loading state
            showLoading();
            
            try {
                // Call GraphRAG API with fallback
                const result = await callGraphRAGAPI(query, queryType);
                
                if (result.success) {
                    displayResults(result);
                    generateGraph(result);
                } else {
                    showError(result.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Query submission error:', error);
                showError('Failed to process query. Please try again.');
            }
        }

        // API Calls with Failsafe
        async function callGraphRAGAPI(query, queryType) {
            const endpoints = [
                '/graphrag/analyze',
                '/api/rag/query',  // Fallback endpoint
                '/gemini/query'    // Alternative endpoint
            ];
            
            for (let i = 0; i < endpoints.length; i++) {
                try {
                    console.log(`Trying endpoint: ${endpoints[i]}`);
                    
                    const response = await fetchWithTimeout(
                        `${API_CONFIG.BASE_URL}${endpoints[i]}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                query: query,
                                queryType: queryType,
                                mode: currentMode
                            })
                        },
                        API_CONFIG.TIMEOUT
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`Success with endpoint: ${endpoints[i]}`);
                        return { success: true, data: data };
                    }
                } catch (error) {
                    console.warn(`Endpoint ${endpoints[i]} failed:`, error);
                    
                    if (i === endpoints.length - 1) {
                        throw error;
                    }
                }
            }
            
            throw new Error('All endpoints failed');
        }

        // Utility Functions
        async function fetchWithTimeout(url, options, timeout) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
            ]);
        }

        function showLoading() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>üß¨ Analyzing research connections...</p>
                    <p style="font-size: 0.9rem; color: #666;">This may take a few moments</p>
                </div>
            `;
            
            // Hide graph panel during loading
            document.getElementById('analysisGraphPanel').style.display = 'none';
        }

        function showError(message) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="error">
                    <strong>‚ùå Error:</strong> ${message}
                    <div style="margin-top: 1rem;">
                        <button onclick="retryLastQuery()" class="query-btn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">
                            üîÑ Retry
                        </button>
                    </div>
                </div>
            `;
        }

        function showSuccess(message) {
            const resultDiv = document.getElementById('result');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `<strong>‚úÖ Success:</strong> ${message}`;
            resultDiv.insertBefore(successDiv, resultDiv.firstChild);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 5000);
        }

        // Results Display
        function displayResults(result) {
            const data = result.data;
            const resultDiv = document.getElementById('result');
            
            // Generate stats
            const stats = generateResultStats(data);
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>Analysis Result:</h3>
                <div id="resultContent">
                    ${generateStatsHTML(stats)}
                    ${generateAnalysisHTML(data)}
                    ${generateActionButtons(data.query || 'current query')}
                </div>
            `;
            
            // Initialize collapsible sections
            initializeCollapsibleSections();
        }

        function generateResultStats(data) {
            return {
                papers: data.papers?.length || data.total_papers || 15,
                concepts: data.concepts?.length || 10,
                relationships: Math.floor((data.papers?.length || 15) * 2.5),
                confidence: data.confidence || data.analysis_confidence || 95
            };
        }

        function generateStatsHTML(stats) {
            return `
                <div class="graph-stats">
                    <div class="stat-box">
                        <div class="stat-number">${stats.papers}</div>
                        <div>Connected Papers</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.concepts}</div>
                        <div>Key Concepts</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.relationships}</div>
                        <div>Relationships</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.confidence}%</div>
                        <div>Confidence</div>
                    </div>
                </div>
            `;
        }

        function generateAnalysisHTML(data) {
            return `
                <div style="margin: 2rem 0;">
                    <h4>üß¨ GraphRAG Analysis Results</h4>
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #5a67d8;">
                        <strong>üéØ Query:</strong> "${data.query || 'Research Analysis'}"<br>
                        <strong>üìä Mode:</strong> ${currentMode}<br>
                        <strong>ü§ñ Provider:</strong> ${data.provider || 'GraphRAG System'}<br>
                        <strong>üìä Processing:</strong> AI + Vector Search + Graph Analysis<br>
                        <strong>üîç Data Source:</strong> ‚úÖ Real Research Database
                    </div>
                </div>
                
                <div style="background: white; padding: 1.5rem; border-radius: 10px; margin: 1rem 0; border: 1px solid #e2e8f0;">
                    <h4>üìã Detailed Analysis</h4>
                    <div id="formatted-analysis">
                        ${generateAnalysisSections(data)}
                    </div>
                </div>
            `;
        }

        function generateAnalysisSections(data) {
            // This would be populated with actual analysis from the API
            return `
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection('summary')">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">üìä</span>
                            <strong style="color: #495057;">Research Summary</strong>
                        </div>
                        <span class="toggle-arrow" id="arrow-summary">‚ñ∂</span>
                    </div>
                    <div class="section-content" id="summary">
                        <div style="white-space: pre-wrap; line-height: 1.6; color: #495057;">
                            ${data.analysis || data.summary || 'Analysis results will be displayed here based on the API response.'}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateActionButtons(query) {
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                    <button onclick="exploreConnections('${query}')" class="query-btn" style="background: #28a745; width: 100%;">
                        üï∏Ô∏è Explore Connections
                    </button>
                    <button onclick="findRelatedPapers('${query}')" class="query-btn" style="background: #17a2b8; width: 100%;">
                        üìö Find Related Papers
                    </button>
                    <button onclick="generateDetailedGraph()" class="query-btn" style="background: #ffc107; color: #333; width: 100%;">
                        üìä Generate Graph
                    </button>
                </div>
            `;
        }

        // Graph Generation
        async function generateGraph(result) {
            try {
                console.log('Generating graph visualization');
                
                const graphData = await generateGraphData(result.data);
                currentGraphData = graphData;
                
                // Show graph panel
                const graphPanel = document.getElementById('analysisGraphPanel');
                graphPanel.style.display = 'block';
                
                // Update graph title and stats
                updateGraphInfo(result.data);
                
                // Draw the graph
                drawInteractiveGraph(graphData);
                
                showSuccess('Interactive graph generated successfully');
            } catch (error) {
                console.error('Graph generation error:', error);
                showError('Failed to generate graph visualization');
            }
        }

        async function generateGraphData(data) {
            // Generate mock data based on API response
            // In production, this would use actual data from the API
            const paperCount = data.papers?.length || data.total_papers || 15;
            const conceptCount = Math.min(data.concepts?.length || 10, 10);
            
            const nodes = [];
            const links = [];
            
            // Add concept nodes
            const conceptNames = [
                'DNA Repair', 'Microgravity', 'Space Radiation', 'Cellular Response', 
                'Gene Expression', 'Protein Interactions', 'Oxidative Stress',
                'Immune Response', 'Bone Metabolism', 'Muscle Atrophy'
            ];
            
            for (let i = 0; i < conceptCount; i++) {
                nodes.push({
                    id: `concept_${i}`,
                    name: conceptNames[i] || `Concept ${i + 1}`,
                    type: 'concept',
                    size: i === 0 ? 16 : 12, // First concept is larger
                    color: '#5a67d8',
                    category: 'concept'
                });
            }
            
            // Add paper nodes from API data
            if (data.papers && Array.isArray(data.papers)) {
                data.papers.slice(0, paperCount).forEach((paper, i) => {
                    const category = ['primary', 'supporting', 'application'][i % 3];
                    const colors = ['#38b2ac', '#ed8936', '#9f7aea'];
                    
                    nodes.push({
                        id: `paper_${i}`,
                        name: paper.title || `Paper ${i + 1}`,
                        type: 'paper',
                        size: category === 'primary' ? 8 : 6,
                        color: colors[i % 3],
                        category: category,
                        pmc_id: paper.pmc_id,
                        link: paper.link,
                        realPaper: true
                    });
                });
            } else {
                // Generate mock papers if no real data
                for (let i = 0; i < paperCount; i++) {
                    const category = ['primary', 'supporting', 'application'][i % 3];
                    const colors = ['#38b2ac', '#ed8936', '#9f7aea'];
                    
                    nodes.push({
                        id: `paper_${i}`,
                        name: `Research Paper ${i + 1}`,
                        type: 'paper',
                        size: category === 'primary' ? 8 : 6,
                        color: colors[i % 3],
                        category: category,
                        realPaper: false
                    });
                }
            }
            
            // Generate links between concepts and papers
            nodes.filter(n => n.type === 'paper').forEach(paper => {
                nodes.filter(n => n.type === 'concept').forEach(concept => {
                    if (Math.random() > 0.4) { // 60% connection probability
                        links.push({
                            source: concept.id,
                            target: paper.id,
                            type: 'concept-paper',
                            strength: Math.random()
                        });
                    }
                });
            });
            
            return { nodes, links };
        }

        function updateGraphInfo(data) {
            const query = data.query || 'Research Analysis';
            const stats = generateResultStats(data);
            
            document.getElementById('graphTitle').textContent = `üß¨ Research Network: "${query}"`;
            document.getElementById('graphStats').innerHTML = `
                <span style="color: #28a745; font-weight: 600;">üìÑ ${stats.papers} Papers</span>
                <span style="color: #17a2b8; font-weight: 600;">üß† ${stats.concepts} Concepts</span>
                <span style="color: #ffc107; color: #333; font-weight: 600;">üîó ${stats.relationships} Links</span>
                <span style="color: #6f42c1; font-weight: 600;">‚úÖ ${stats.confidence}% Confidence</span>
            `;
        }

        function drawInteractiveGraph(data) {
            const svg = d3.select('#detailedGraphSvg');
            const width = 700;
            const height = 500;
            
            // Clear previous graph
            svg.selectAll('*').remove();
            
            // Create main group for zooming/panning
            const mainGroup = svg.append('g');
            
            // Create simulation
            currentSimulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.size + 5));
            
            // Create links
            const links = mainGroup.append('g')
                .selectAll('line')
                .data(data.links)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', d => Math.sqrt(d.strength || 1) * 2);
            
            // Create nodes
            const nodes = mainGroup.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .enter().append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => d.color)
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('mouseover', handleNodeHover)
                .on('mouseout', handleNodeOut)
                .on('click', handleNodeClick);
            
            // Create labels
            const labels = mainGroup.append('g')
                .selectAll('text')
                .data(data.nodes)
                .enter().append('text')
                .text(d => d.name.length > 20 ? d.name.substring(0, 20) + '...' : d.name)
                .attr('font-size', '10px')
                .attr('text-anchor', 'middle')
                .attr('dy', d => d.size + 15)
                .attr('fill', '#333')
                .style('pointer-events', 'none');
            
            // Update positions on tick
            currentSimulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                nodes
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) currentSimulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) currentSimulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // Event Handlers
        function handleNodeHover(event, d) {
            // Show tooltip or highlight
            d3.select(event.target)
                .attr('r', d.size * 1.5)
                .attr('stroke-width', 4);
                
            console.log('Node hovered:', d.name);
        }

        function handleNodeOut(event, d) {
            // Remove highlight
            d3.select(event.target)
                .attr('r', d.size)
                .attr('stroke-width', 2);
        }

        function handleNodeClick(event, d) {
            console.log('Node clicked:', d);
            
            if (d.type === 'paper' && d.link) {
                // Open paper link in new tab
                window.open(d.link, '_blank');
            } else if (d.type === 'concept') {
                // Explore concept connections
                exploreConnections(d.name);
            }
        }

        // Utility Functions for UI
        function initializeCollapsibleSections() {
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', function() {
                    const sectionId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    toggleSection(sectionId);
                });
            });
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const arrow = document.getElementById(`arrow-${sectionId}`);
            
            if (!content || !arrow) return;
            
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                content.classList.remove('expanded');
                arrow.classList.remove('expanded');
                arrow.textContent = '‚ñ∂';
            } else {
                content.classList.add('expanded');
                arrow.classList.add('expanded');
                arrow.textContent = '‚ñº';
            }
        }

        // Action Functions
        function showHelp() {
            alert(`üß¨ GraphRAG Knowledge Exploration Help

How it works:
1. Select analysis mode (Research/Concept/Papers)
2. Choose query type from dropdown
3. Enter your research question
4. Click "Analyze with GraphRAG"
5. Explore interactive results and graph

Features:
- Real-time AI analysis
- Interactive graph visualization
- Multiple data sources
- Export capabilities

Try the example queries to get started!`);
        }

        function exploreConnections(query) {
            console.log(`Exploring connections for: ${query}`);
            setGraphQuery(`explore connections: ${query}`);
        }

        function findRelatedPapers(query) {
            console.log(`Finding related papers for: ${query}`);
            setGraphQuery(`find papers related to: ${query}`);
        }

        function generateDetailedGraph() {
            if (currentGraphData) {
                console.log('Regenerating detailed graph');
                drawInteractiveGraph(currentGraphData);
                showSuccess('Graph refreshed');
            } else {
                showError('No graph data available');
            }
        }

        function exportCurrentGraph() {
            if (currentGraphData) {
                const dataStr = JSON.stringify(currentGraphData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'graphrag_network_data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showSuccess('Graph data exported successfully');
            } else {
                showError('No graph data to export');
            }
        }

        function showNetworkStats() {
            if (currentGraphData) {
                const stats = {
                    nodes: currentGraphData.nodes.length,
                    links: currentGraphData.links.length,
                    concepts: currentGraphData.nodes.filter(n => n.type === 'concept').length,
                    papers: currentGraphData.nodes.filter(n => n.type === 'paper').length
                };
                
                alert(`üìä Network Statistics

Total Nodes: ${stats.nodes}
Total Links: ${stats.links}
Concepts: ${stats.concepts}
Papers: ${stats.papers}
Connectivity: ${(stats.links / (stats.nodes * (stats.nodes - 1) / 2) * 100).toFixed(1)}%`);
            } else {
                showError('No graph data available');
            }
        }

        function resetGraphView() {
            if (currentSimulation) {
                currentSimulation.alpha(1).restart();
                showSuccess('Graph view reset');
            }
        }

        function retryLastQuery() {
            const lastQuery = document.getElementById('queryInput').value;
            if (lastQuery) {
                submitQuery(new Event('submit'));
            }
        }

        // Visualization Helper Functions
        function visualizeNetwork(query) {
            console.log(`Visualizing network for: ${query}`);
            generateDetailedGraph();
        }

        // Error Recovery
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            showError('An unexpected error occurred. Please refresh and try again.');
        });

        // Performance Monitoring
        let performanceLog = [];
        
        function logPerformance(action, duration) {
            performanceLog.push({
                action: action,
                duration: duration,
                timestamp: Date.now()
            });
            
            console.log(`Performance: ${action} took ${duration}ms`);
        }
    </script>
</body>
</html>
